# Homebrew Tap Setup Guide

This guide explains how to set up the Homebrew tap repository for dddns to enable `brew install` support.

## Prerequisites

1. GitHub account with access to create repositories under `descoped` organization
2. Personal Access Token (PAT) with `repo` scope

## Setup Steps

### 1. Create the Tap Repository

Create a new GitHub repository named `homebrew-tap` under the `descoped` organization:

```bash
# Repository name MUST start with "homebrew-" for tap shortcuts to work
https://github.com/descoped/homebrew-tap
```

Initialize with:
- Public visibility
- README.md
- MIT License (same as dddns)

### 2. Create Repository Structure

```
homebrew-tap/
├── Formula/
│   └── (will be auto-generated by GoReleaser)
└── README.md
```

### 3. Create Initial README

```markdown
# Descoped Homebrew Tap

Homebrew formulae for Descoped projects.

## Installation

```bash
brew install descoped/tap/dddns
```

## Available Formulae

- `dddns` - Dynamic DNS updater for AWS Route53

## How do I install these formulae?

`brew install descoped/tap/<formula>`

Or `brew tap descoped/homebrew-tap` and then `brew install <formula>`.

## Documentation

For more information about dddns, visit [github.com/descoped/dddns](https://github.com/descoped/dddns)
```

### 4. Generate Personal Access Token

1. Go to GitHub Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Click "Generate new token (classic)"
3. Name: `HOMEBREW_TAP_TOKEN`
4. Select scopes:
   - `repo` (full control of private repositories)
   - Note: Even for public repos, this is needed for cross-repo pushes
5. Generate and copy the token

### 5. Add Token to GitHub Actions Secrets

In the main `dddns` repository:

1. Go to Settings → Secrets and variables → Actions
2. Click "New repository secret"
3. Name: `HOMEBREW_TAP_TOKEN`
4. Value: (paste the PAT from step 4)

### 6. Test the Setup

After setup, the next release will:
1. Build binaries as usual
2. Generate a Homebrew formula
3. Push the formula to `descoped/homebrew-tap`
4. Users can then install with `brew install descoped/tap/dddns`

## How It Works

1. **On Release**: When a new version is tagged (e.g., `v0.1.2`), GoReleaser:
   - Builds all binaries
   - Creates GitHub release
   - Generates `Formula/dddns.rb` with correct URLs and checksums
   - Pushes formula to homebrew-tap repository

2. **User Installation**:
   ```bash
   # First time
   brew install descoped/tap/dddns

   # Updates
   brew upgrade dddns
   ```

3. **Formula Updates**: Automatic via GoReleaser on each release

## Troubleshooting

### Token Issues
- Ensure PAT has `repo` scope
- Check token hasn't expired
- Verify secret name matches exactly: `HOMEBREW_TAP_TOKEN`

### Formula Generation Issues
- Check GoReleaser logs in GitHub Actions
- Verify `.goreleaser.yaml` brews configuration
- Ensure archive names match expected format

### Installation Issues
- Run `brew tap descoped/homebrew-tap` manually first
- Check formula syntax with `brew audit descoped/tap/dddns`
- Clear Homebrew cache: `brew cleanup -s`

## Alternative: Local Tap Testing

Before creating the official tap, you can test locally:

```bash
# Create local tap structure
mkdir -p ~/homebrew-local-tap/Formula

# Copy a test formula
cp /path/to/dddns.rb ~/homebrew-local-tap/Formula/

# Add local tap
brew tap local/tap ~/homebrew-local-tap

# Test installation
brew install local/tap/dddns
```

## Future Enhancements

- Add bottle (pre-compiled binary) support for faster installation
- Support for versioned formulas (`dddns@0.1`)
- Automated testing of formula before push
- Support for other package managers (Scoop for Windows)

## References

- [Homebrew Tap Documentation](https://docs.brew.sh/How-to-Create-and-Maintain-a-Tap)
- [GoReleaser Homebrew Documentation](https://goreleaser.com/customization/homebrew/)
- [GitHub Actions Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)